<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<title>MAM</title>

	<script type="text/javascript" src="./iota.min.js"></script>
	<script type="text/javascript" src="./old.curl.min.js"></script>
	<script type="text/javascript" src="./mam.web.js"></script>

</head>
<body>

    <h1> MAMmm </h1>
    <button onclick="startPublishing()">start publishing</button> 

    <script type="text/javascript">
        "use strict";



var iota = new IOTA({
	host: 'https://node02.iotatoken.nl',
	port: 443
});

var Mam = require('mam.web.js');

curl.init();
curl.overrideAttachToTangle(iota);



function startPublishing() {

    let mamState = Mam.init(iota, 'JGYXBBVFGBFCTQYJUGFYTBULA99NWPKG9KINFQQQH9CCSUAIAVHXMATRGLQZQWKUXIQUXXAHQNYGZXATR', 2);

    const publish = async function(packet) {

      let trytes = iota.utils.toTrytes(JSON.stringify(packet));
      let message = Mam.create(mamState, trytes);

		// Save new mamState
		mamState = message.state;

		// Attach the payload
		await Mam.attach(message.payload, message.address);
		return message.root;
	}

	const executeDataPublishing = async function() {
		
		let root = await publish({number: Math.random()});
		console.log(root);
	}

	executeDataPublishing();


	setInterval(executeDataPublishing, 30 * 1000);
}



</script>

</body>
</html>
